version: '3'

tasks:
  clean-all:
    vars:
      TOOLS: 
        sh: 'ls {{.TOOLS_SANDBOX}}'
    cmds:
      - for: { var: TOOLS }
        cmd: rm -rvf '{{.TOOLS_BIN_DIR}}/{{.ITEM}}'
      - rm -rvf {{.TOOLS_SANDBOX}}

  clean:
    cmds:
      - rm -rvf '{{.TOOLS_SANDBOX}}/{{.TOOL_NAME}}'
      - rm -vf '{{.TOOLS_BIN_DIR}}/{{.TOOL_NAME}}'

  create-sandbox:
    internal: true
    requires:
      vars: [TOOLS_SANDBOX, TOOL_NAME]
    cmds:
      - mkdir -p '{{.TOOLS_SANDBOX}}/{{.TOOL_NAME}}'

  install-from-gh:
    dir: '{{.TOOL_SANDBOX}}'
    requires:
      vars: [TOOLS_SANDBOX, TOOLS_BIN_DIR, TOOL_NAME, TOOL_VERSION, TOOL_DL_URL]
    vars:
      TOOL_SANDBOX: '{{.TOOLS_SANDBOX}}/{{.TOOL_NAME}}'
      TOOL_CMD_PATH: '{{.USER_WORKING_DIR}}/{{.TOOL_SANDBOX}}/{{.TOOL_NAME}}'
      TOOL_BIN_PATH: '{{.TOOLS_BIN_DIR}}/{{.TOOL_NAME}}'
      TOOL_DL_NAME: '{{.TOOL_DL_URL | splitList "/" | last}}'
    preconditions:
      - sh: '[ ! -f {{.TOOL_CMD_PATH}} ]'
        msg: '"{{.TOOL_NAME}}" already installed'
    cmds:
      - task: clean
      - task: create-sandbox
      - curl -sL --remote-name {{.TOOL_DL_URL}}
      - tar -xz -C . -f '{{.TOOL_DL_NAME}}'
      - ln -s '{{.TOOL_CMD_PATH}}' '{{.TOOL_BIN_PATH}}'
